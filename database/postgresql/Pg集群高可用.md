-   Date: 2022-07-04
-   Author: Michael
-   Keyword: #pg 

# PG集群高可用
## 故障检测

## 高可用方案
各个功能对比图。
![](Pasted%20image%2020220706100516.png)
### 共享磁盘
多个服务器共享一个磁盘，比如云服务器的PVC。当主数据库服务故障时，备用库能直接挂载共享磁盘并启动。
- 优点：不需要额外的数据同步开销，实现简单。

### 文件系统复制
基于操作系统的文件系统复制方案，将数据库的数据文件实时同步到备库服务器上。
- 优点：对比共享磁盘，不需要特殊的硬件支持。

### 流复制
通过传输WAL日志来使得备库与主库保存同步，支持同步和异步两种。只能用于整个数据库服务器。备库不支持写操作，但当主库挂掉后，可以快速的将备库升级为主库。Postgresql本身不支持主库的故障检测以及备库的自动升级，需要一些中间件产品来提供这些支持。
同步复制需要至少一台备份响应接收到WAL日志后，主库才提交，否则会一直等待。在一主一备的模式下不建议使用同步，这样当备库挂掉后，主库也无法提供服务。
异步复制在高压下宕机后，可能会出现数据未同步到备库的情况，这时可以借助第三方工具，实现当主备的数据延时不超过最大限定时，允许切换的功能。



## 解决方案
### PGPool-II

### Patroni
支持版本：9.3 -> 14

### ClusterControl
[官方地址](https://severalnines.com/pricing/#plan-comparison)
支持版本 9.x ->
一款商业产品，支持多款数据库的部署、集群管理、负载均衡和故障转移等功能。

### Keepalived